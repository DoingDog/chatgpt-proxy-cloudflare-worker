addEventListener("fetch",e=>{e.respondWith(handleRequest(e.request).catch(({stack:e})=>new Response(e,{headers:{"Content-Type":"text/plain;charset=utf8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"*"},status:500})))});async function handleRequest(e){let t={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"*"};if(e.url===`${new URL(e.url).origin}/`){let a=await e.clone().text(),n={url:e.url,method:e.method,data:a,headers:Object.fromEntries(e.headers),cf:Object.fromEntries(Object.entries(e.cf))};return new Response(JSON.stringify(n,null,2),{headers:t})}function s(e){var a;let n={400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",408:"Request Timeout",410:"Gone",413:"Payload Too Large",429:"Too Many Requests",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable"};return n[e]?(a=n[e],new Response(JSON.stringify({error:{message:`${e} ${a}`,code:e}},null,2),{headers:t,status:e})):null}if("POST"!==e.method&&"GET"!==e.method&&"OPTIONS"!==e.method)return s(405);let o=new URL(e.url),r=["completions","generations","transcriptions","edits","embeddings","translations","variations","files","fine-tunes","moderations","models","listBaseModel","openai","kamiya","generate","conversation"],i=await e.clone().text(),l=o.pathname.split("?")[0].split("/").pop(),h="undefined"!=typeof API_KEY&&""!==API_KEY?API_KEY.split(","):["sk-xxxxxxxxxx"],c="undefined"!=typeof KAMIYA_TOKEN&&""!==KAMIYA_TOKEN?KAMIYA_TOKEN.split(","):["sk-xxxxxxxxxx"],d="undefined"!=typeof PASSWORD&&""!==PASSWORD?PASSWORD.split(","):["cpcw"],p=`Bearer ${h[Math.floor(Math.random()*h.length)]}`,m=`Bearer ${c[Math.floor(Math.random()*c.length)]}`;if(r.includes(l)&&("POST"===e.method||"GET"===e.method)){let u=e.headers.get("Authorization");if(!u)return s(401);let f=u.substring(7);d.includes(f)||(p=u,m=u)}else if(!r.includes(l)&&!["usage","getDetails","history"].includes(l))return s(403);let g=Object.fromEntries(e.headers);switch(Object.assign(g,{"user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36","sec-ch-ua":'"Chromium";v="116", "Google Chrome";v="116", "Not:A-Brand";v="99"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site",Pragma:"no-cache","Cache-Control":"no-cache","content-type":"application/json","X-Forwarded-For":"1.1.1.1","X-Real-IP":"1.1.1.1"}),!0){case o.pathname.startsWith("/openai"):case o.pathname.startsWith("/v1/"):o.host="api.openai.com",o.pathname=o.pathname.replace(/^\/openai\//,"/"),o.pathname=o.pathname.replace(/^\/openai$/,"/v1/chat/completions"),Object.assign(g,{authorization:p,origin:"https://bettergpt.chat",referer:"https://bettergpt.chat/",authority:o.host});break;case o.pathname.startsWith("/kamiya"):if(o.pathname.endsWith("/models")){let w=await fetch("https://gist.githubusercontent.com/DoingDog/5d9f8228d02645bb2ace999de796e5b9/raw/fakeModels.json");return new Response(w.body,{headers:t})}o.host="p0.kamiya.dev",o.pathname=o.pathname.replace(/^\/kamiya\//,"/"),o.pathname=o.pathname.replace(/^\/kamiya$/,"/v1/chat/completions"),o.pathname=o.pathname.replace(/^\/v1\//,"/api/openai/"),o.pathname=o.pathname.replace(/^\/usage$/,"/api/session/getDetails"),Object.assign(g,{authorization:m,origin:"https://chat.kamiya.dev",referer:"https://chat.kamiya.dev/",authority:o.host});break;default:return s(404)}let y=new Headers;Object.entries(g).forEach(([e,t])=>{y.append(e,t)});let $;try{$=new Request(o.toString(),{headers:y,body:e.body,method:e.method,redirect:"follow"})}catch(_){return s(400)}if("POST"===e.method&&o.pathname.endsWith("/completions")&&i)try{let x=JSON.parse(i),b=x.messages,v=b[b.length-1],A=v.content,C=b[b.length-3]?.content||"";if(A.includes("WS[")||C.includes("WS[")){let S=[];function k(e,t){let a=0,n=e.match(/WS\[[^\]]+\]/g);return n&&n.forEach(e=>{let n=e.slice(3,-1);a<2&&(t.push(n),a++)}),null}if(k(A,S),C&&k(C,S),S.length>=1){let T=[],q=S.length<=2?10:5;for(let O of S)try{let W=await fetch(`https://s0.awsl.app/search?q=${O}&max_results=${q}`),E=await W.json(),G=E.map(({title:e,body:t,href:a})=>`'${e}' : ${t} ; (${a})`).join("\n");T.push(`

[${O}]
${G}`)}catch(M){try{let P=await fetch(`https://ddg-api.herokuapp.com/search?query=${O}&limit=${q}`),j=await P.json(),B=j.map(({title:e,snippet:t,link:a})=>`'${e}' : ${t} ; (${a})`).join("\n");T.push(`

[${O}]
${B}`)}catch(R){return s(502)}}v.content=`${A.replace(/WS\[[^\]]*\]/g,"")}

Current date:${new Date().toLocaleString()} UTC

Instructions: Reply to me in the language of my request or question above. Give a comprehensive answer to the question or request I have made above. Below are some results from a web search. Use them if necessary.
${T}`,x.messages[b.length-1]=v,$=new Request($,{body:JSON.stringify(x)})}}}catch(I){return s(400)}try{let z=await fetch($),H=s(z.status);if(("POST"===e.method||"GET"===e.method)&&o.pathname.endsWith("/completions")&&H)return H;let D=new Response(z.body,z);return D.headers.set("Access-Control-Allow-Origin",e.headers.get("Access-Control-Allow-Origin")||"*"),D.headers.set("Access-Control-Allow-Headers",e.headers.get("Access-Control-Allow-Headers")||"*"),D}catch(F){return s(502)}}
